import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc,
  query,
  where,
  serverTimestamp,
  Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase Ë®≠ÂÆö */
const firebaseConfig = {
  apiKey: "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ",
  authDomain: "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ",
  projectId: "minotani-sc-app",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM */
const table = document.getElementById("table");
const stats = document.getElementById("stats");
const monthLabel = document.getElementById("monthLabel");

/* state */
let current = new Date();
let rendering = false;

/* „Ç≠„É£„ÉÉ„Ç∑„É• */
let players = [];
let events = [];
let logsCacheByMonth = {}; 
// { "2026-01": { "eventId_playerId": {status, time} } }

/* ÊúàÂàáÊõø */
document.getElementById("prevMonth").onclick = () => {
  if (rendering) return;
  current.setDate(1);
  current.setMonth(current.getMonth() - 1);
  render();
};
document.getElementById("nextMonth").onclick = () => {
  if (rendering) return;
  current.setDate(1);
  current.setMonth(current.getMonth() + 1);
  render();
};

render();

/* utils */
function toDate(v) {
  if (!v) return null;
  if (typeof v === "string") {
    const [y, m, d] = v.split("-").map(Number);
    return new Date(y, m - 1, d);
  }
  if (v instanceof Timestamp) return v.toDate();
  return null;
}
function monthIdOf(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
}
function symbol(s) {
  if (s === "present") return "‚óã";
  if (s === "absent") return "√ó";
  if (s === "tc") return "‚Äª"; // „Éà„É¨„Çª„É≥ÔºàÂá∫Â∏≠Êâ±„ÅÑÔºâ
  return "Ôºç";
}

/* ===============================
   Âá∫Â∏≠ÁéáÊèèÁîªÔºàË™≠„ÅøÂèñ„Çä„Å™„ÅóÔºâ
   =============================== */
function renderStats(players, monthEvents, logsCache) {
  stats.innerHTML = "";

  players.forEach(p => {
    let prH = 0, prT = 0, maH = 0, maT = 0;

    monthEvents.forEach(e => {
      const s = logsCache[`${e.id}_${p.id}`]?.status;
      if (!s || s === "skip") return;

      const isHit = s === "present" || s === "tc";

      if (e.type === "practice") {
        prT++;
        if (isHit) prH++;
      }
      if (e.type === "match") {
        maT++;
        if (isHit) maH++;
      }
    });

    const tot = prT + maT;
    const hit = prH + maH;

    stats.innerHTML += `
      <div class="statsCard">
        <strong>${p.name}</strong><br>
        Á∑¥ÁøíÔºö${prH}/${prT}Ôºà${prT ? Math.round(prH / prT * 100) : 0}%Ôºâ<br>
        Ë©¶ÂêàÔºö${maH}/${maT}Ôºà${maT ? Math.round(maH / maT * 100) : 0}%Ôºâ<br>
        ÂêàË®àÔºö${hit}/${tot}Ôºà${tot ? Math.round(hit / tot * 100) : 0}%Ôºâ
      </div>
    `;
  });
}

/* ===============================
   „É°„Ç§„É≥ÊèèÁîª
   =============================== */
async function render() {
  rendering = true;
  table.innerHTML = "";
  stats.innerHTML = "";
  monthLabel.textContent = `${current.getFullYear()}Âπ¥ ${current.getMonth() + 1}Êúà`;

  const monthId = monthIdOf(current);

  /* playersÔºàÂàùÂõû„ÅÆ„ÅøÔºâ */
  if (players.length === 0) {
    const snap = await getDocs(collection(db, "players_attendance"));
    players = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .sort((a, b) => (a.number ?? 999) - (b.number ?? 999));
  }

  /* eventsÔºàÂàùÂõû„ÅÆ„ÅøÔºâ */
  if (events.length === 0) {
    const snap = await getDocs(collection(db, "events_attendance"));
    events = snap.docs
      .map(d => {
        const data = d.data();
        return { id: d.id, ...data, _date: toDate(data.date) };
      })
      .filter(e => e.type !== "holiday")
      .sort((a, b) => a._date - b._date);
  }

  /* ÂΩìÊúà„Ç§„Éô„É≥„Éà */
  const monthEvents = events.filter(
    e =>
      e._date &&
      e._date.getFullYear() === current.getFullYear() &&
      e._date.getMonth() === current.getMonth()
  );

  /* attendance_logsÔºàÊúà1Âõû„Å†„ÅëÂèñÂæóÔºâ */
  if (!logsCacheByMonth[monthId]) {
    logsCacheByMonth[monthId] = {};
    const snap = await getDocs(
      query(collection(db, "attendance_logs"), where("monthId", "==", monthId))
    );

    snap.forEach(doc => {
      const d = doc.data();
      const key = `${d.eventId}_${d.playerId}`;
      const t = d.createdAt?.toMillis?.() ?? 0;
      if (
        !logsCacheByMonth[monthId][key] ||
        t > logsCacheByMonth[monthId][key].time
      ) {
        logsCacheByMonth[monthId][key] = { status: d.status, time: t };
      }
    });
  }

  const logsCache = logsCacheByMonth[monthId];

  /* ---------- table header ---------- */
  const trH = document.createElement("tr");

  const thNo = document.createElement("th");
  thNo.className = "no";
  thNo.textContent = "ËÉå";
  trH.appendChild(thNo);

  const thName = document.createElement("th");
  thName.className = "name";
  thName.textContent = "ÂêçÂâç";
  trH.appendChild(thName);

  monthEvents.forEach(e => {
    const th = document.createElement("th");
    th.className = e.type;
    th.innerHTML = `${e._date.getDate()}<br>${e.type === "match" ? "Ë©¶Âêà" : "Á∑¥Áøí"}`;
    trH.appendChild(th);
  });

  table.appendChild(trH);

  /* ---------- table body ---------- */
  players.forEach(p => {
    const tr = document.createElement("tr");

    // ‚òÖ‚òÖ‚òÖ „Åì„Åì„ÅåÈáçË¶ÅÔºöinnerHTML„Çí‰Ωø„Çè„ÅöÁ¢∫ÂÆü„Å´Âõ∫ÂÆö ‚òÖ‚òÖ‚òÖ
    const tdNo = document.createElement("td");
    tdNo.className = "no";
    tdNo.textContent = p.number ?? "";
    tr.appendChild(tdNo);

    const tdName = document.createElement("td");
    tdName.className = "name";
    tdName.textContent = p.name;
    tr.appendChild(tdName);

    monthEvents.forEach(e => {
      const key = `${e.id}_${p.id}`;
      const td = document.createElement("td");
      td.className = e.type;
      td.textContent = symbol(logsCache[key]?.status || "skip");

      td.onclick = async () => {
        if (rendering) return;
        rendering = true;

        const cur = logsCache[key]?.status || "skip";
        const next =
          cur === "skip" ? "present" :
          cur === "present" ? "absent" :
          cur === "absent" ? "tc" :
          "skip";

        await addDoc(collection(db, "attendance_logs"), {
          eventId: e.id,
          playerId: p.id,
          status: next,
          monthId,
          createdAt: serverTimestamp()
        });

        logsCache[key] = { status: next, time: Date.now() };
        td.textContent = symbol(next);

        renderStats(players, monthEvents, logsCache);
        rendering = false;
      };

      tr.appendChild(td);
    });

    table.appendChild(tr);
  });

  renderStats(players, monthEvents, logsCache);
  rendering = false;
}

/* ===============================
   CSV Âá∫ÂäõÔºàÂÖÉ„ÅÆ„Åæ„ÅæÔºâ
   =============================== */
window.exportCSV = function () {
  const lines = [];

  lines.push(["‚öΩ Âá∫Ê¨†ÁÆ°ÁêÜ"]);
  lines.push([`${current.getFullYear()}Âπ¥${current.getMonth() + 1}Êúà`]);
  lines.push([]);

  const headers = ["ËÉåÁï™Âè∑", "ÂêçÂâç"];
  document.querySelectorAll("th:not(.no):not(.name)").forEach(h => {
    headers.push(h.innerText.replace(/\n/g, ""));
  });
  lines.push(headers);

  document.querySelectorAll("#table tr").forEach((tr, i) => {
    if (i === 0) return;
    const row = [];
    tr.querySelectorAll("td").forEach(td => row.push(td.innerText));
    lines.push(row);
  });

  lines.push([]);
  lines.push(["üìä Âá∫Â∏≠Áéá"]);
  document.querySelectorAll(".statsCard").forEach(card => {
    lines.push([card.innerText.replace(/\n/g, " ")]);
  });

  const csv =
    "\uFEFF" +
    lines
      .map(r => r.map(c => `"${c.replace(/"/g, '""')}"`).join(","))
      .join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `${monthIdOf(current)}_attendance.csv`;
  a.click();
  URL.revokeObjectURL(url);
};
