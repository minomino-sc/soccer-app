import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  addDoc, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "★★★★★",
  authDomain: "★★★★★",
  projectId: "minotani-sc-app",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const table = document.getElementById("table");
let latestStatus = {};
let current = new Date();

render();

async function render(){
  table.innerHTML = "";

  /* ★ 背番号順で取得 */
  const playersSnap = await getDocs(
    query(collection(db,"players_attendance"), orderBy("number","asc"))
  );

  const eventsSnap = await getDocs(
    query(collection(db,"events_attendance"), orderBy("date","asc"))
  );

  const logsSnap = await getDocs(
    query(collection(db,"attendance_logs"), orderBy("createdAt","asc"))
  );

  const players = playersSnap.docs.map(d=>({id:d.id,...d.data()}));

  const events = eventsSnap.docs
    .map(d=>({id:d.id,...d.data()}))
    .filter(e=>{
      const d = new Date(e.date);
      return d.getFullYear()===current.getFullYear() &&
             d.getMonth()===current.getMonth();
    });

  latestStatus = {};
  logsSnap.forEach(l=>{
    const d=l.data();
    latestStatus[`${d.eventId}_${d.playerId}`] = d.status;
  });

  /* ヘッダ */
  const trH = document.createElement("tr");
  trH.innerHTML =
    `<th>背番</th><th>名前</th>` +
    events.map(e=>{
      const d=new Date(e.date);
      const cls=e.type==="match"?"match":"practice";
      return `<th class="${cls}">${d.getDate()}</th>`;
    }).join("");
  table.appendChild(trH);

  /* 行 */
  players.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${p.number}</td><td class="name">${p.name}</td>`;

    events.forEach(e=>{
      const key=`${e.id}_${p.id}`;
      const status=latestStatus[key] || "unset";

      const td=document.createElement("td");
      td.textContent =
        status==="present"?"○":
        status==="absent"?"×":
        status==="skip"?"－":"";

      td.onclick = async ()=>{
        const next =
          status==="present" ? "absent" :
          status==="absent" ? "skip" :
          "present";

        await addDoc(collection(db,"attendance_logs"),{
          eventId:e.id,
          playerId:p.id,
          status:next,
          createdAt:serverTimestamp()
        });
        render();
      };
      tr.appendChild(td);
    });

    table.appendChild(tr);
  });
}
